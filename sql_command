# create table command
CREATE TABLE past_delivery_data (
    serial INTEGER, 
    model TEXT, 
    HP_case_id TEXT, 
    company_name TEXT,
    order_date INTEGER,
    arrive_date INTEGER,
    goods_receiver_name TEXT,
    address TEXT,
    goods_receiver_phone TEXT,
    goods_name TEXT,
    quantity INTEGER,
    remark TEXT, goods_type TEXT, unamed TEXT
)

CREATE TABLE deliver_status (
    last_deliver_date TEXT,
    serial_number TEXT,
    goods_name TEXT,
    goods_type TEXT,
    need_refill TEXT,
    PRIMARY KEY(serial_number, goods_name, goods_type)
)

CREATE TABLE consumable_levels (
    `Report Content DateTime` TEXT,
    `Customer Name` TEXT,
    `Country` TEXT,
    `Region` TEXT,
    `Site` TEXT,
    `Building` TEXT,
    `Level` INTEGER,
    `Product Model Name` TEXT,
    `Asset Number` TEXT,
    `Serial Number` TEXT,
    `Usage Count Date` TEXT,
    `Black Level` INTEGER,
    `Cyan Level` INTEGER,
    `Magenta Level` INTEGER,
    `Yellow Level` INTEGER,
    `Light Cyan Level` INTEGER,
    `Light Magenta Level` INTEGER,
    `Tri-Color Level` INTEGER,
    `Bonding Agent Level` INTEGER,
    `Staple Level` INTEGER,
    `Staple Second Level` INTEGER,
    `Staple Third Level` INTEGER,
    `Cyan Drum Level` INTEGER,
    `Yellow Drum Level` INTEGER,
    `Magenta Drum Level` INTEGER,
    `Black Drum Level` INTEGER,
    `Drum Kit Level` INTEGER,
    `Transfer Kit Level` INTEGER,
    `Fuser Kit Level` INTEGER,
    `Cleaning Kit Level` INTEGER,
    `Maintenance Combo Kit Level` INTEGER,
    `Document Feeder Kit Level` INTEGER,
    `Roller Level` INTEGER,
    `Grey Level` INTEGER,
    `Light Grey Level` INTEGER,
    `Photo Black Level` INTEGER,
    `Matte Black Level` INTEGER,
    `Red Level` INTEGER,
    `Green Level` INTEGER,
    `Blue Level` INTEGER,
    `Gloss Enhancer Level` INTEGER,
    `Pen Wipe Level` INTEGER,
    `Collection Unit Level` INTEGER,
    `Black Developer Maintenance Level` INTEGER,
    `Cyan Developer Maintenance Level` INTEGER,
    `Magenta Developer Maintenance Level` INTEGER,
    `Yellow Developer Maintenance Level` INTEGER,
    PRIMARY KEY(`Report Content DateTime`, `Serial Number`)
)

# 紀錄各設備最後派送狀態
CREATE TABLE deliver_status (
    `Last Deliver Date` TEXT,
    `Customer Name` TEXT,
    `Site` TEXT,
    `Building` TEXT,
    `Level` TEXT,
    `Product Model Name` TEXT,
    `Asset Number` TEXT,
    `Serial Number` TEXT,
    `Usage Count Date` TEXT,
    `Black Level` INTEGER,
    `Cyan Level` INTEGER,
    `Magenta Level` INTEGER,
    `Yellow Level` INTEGER,
    `Cyan Drum Level` INTEGER,
    `Yellow Drum Level` INTEGER,
    `Magenta Drum Level` INTEGER,
    `Black Drum Level` INTEGER,
    `Drum Kit Level` INTEGER,
    `Transfer Kit Level` INTEGER,
    `Fuser Kit Level` INTEGER,
    `Cleaning Kit Level` INTEGER,
    `Maintenance Combo Kit Level` INTEGER,
    `Document Feeder Kit Level` INTEGER,
    `Roller Level` INTEGER,
    PRIMARY KEY(`Serial Number`)
)

# 昨天的紀錄
select *, DATE(substr(`Report Content DateTime`, 7, 4) ||
	'-' ||
	substr(`Report Content DateTime`, 1, 2) ||
	'-' ||
	substr(`Report Content DateTime`, 4, 2)
	)  as 'datetime'
from consumable_levels where datetime = DATE('NOW','-1 DAY')

# [嘗試][有效能問題] 撈出比前一天 level 要小的顏色，若數值沒變動則設為 N/A
select DISTINCT 
	today.`Serial Number`,
	today.datetime,
    case
    when yesterday.`Black Level` - today.`Black Level` >= 1
    	then today.`Black Level`
    	else 'N/A'
    END `Black Level`,
    case
    when yesterday.`Cyan Level` - today.`Cyan Level` >= 1
    	then today.`Cyan Level`
    	else 'N/A'
    END `Cyan Level`,
    case
    when yesterday.`Magenta Level` - today.`Magenta Level` >= 1
    	then today.`Magenta Level`
    	else 'N/A'
    END `Magenta Level`,
    case
    when yesterday.`Cyan Drum Level` - today.`Cyan Drum Level` >= 1
    	then today.`Cyan Drum Level`
    	else 'N/A'
    END `Cyan Drum Level`,
    case
    when yesterday.`Yellow Drum Level` - today.`Yellow Drum Level` >= 1
    	then today.`Yellow Drum Level`
    	else 'N/A'
    END `Yellow Drum Level`,
    case
    when yesterday.`Magenta Drum Level` - today.`Magenta Drum Level` >= 1
    	then today.`Magenta Drum Level`
    	else 'N/A'
    END `Magenta Drum Level`,
    case
    when yesterday.`Black Drum Level` - today.`Black Drum Level` >= 1
    	then today.`Black Drum Level`
    	else 'N/A'
    END `Black Drum Level`,
    case
    when yesterday.`Drum Kit Level` - today.`Drum Kit Level` >= 1
    	then today.`Drum Kit Level`
    	else 'N/A'
    END `Drum Kit Level`,
    case
    when yesterday.`Transfer Kit Level` - today.`Transfer Kit Level` >= 1
    	then today.`Transfer Kit Level`
    	else 'N/A'
    END `Transfer Kit Level`,
    case
    when yesterday.`Fuser Kit Level` - today.`Fuser Kit Level` >= 1
    	then today.`Fuser Kit Level`
    	else 'N/A'
    END `Fuser Kit Level`,
    case
    when yesterday.`Cleaning Kit Level` - today.`Cleaning Kit Level` >= 1
    	then today.`Cleaning Kit Level`
    	else 'N/A'
    END `Cleaning Kit Level`,
    case
    when yesterday.`Maintenance Combo Kit Level` - today.`Maintenance Combo Kit Level` >= 1
    	then today.`Maintenance Combo Kit Level`
    	else 'N/A'
    END `Maintenance Combo Kit Level`,
    case
    when yesterday.`Document Feeder Kit Level` - today.`Document Feeder Kit Level` >= 1
    	then today.`Document Feeder Kit Level`
    	else 'N/A'
    END `Document Feeder Kit Level`,
    case
    when yesterday.`Roller Level` - today.`Roller Level` >= 1
    	then today.`Roller Level`
    	else 'N/A'
    END `Roller Level`
from
	(select DATE(substr(`Report Content DateTime`, 7, 4) || '-' ||
	substr(`Report Content DateTime`, 1, 2) || '-' ||
	substr(`Report Content DateTime`, 4, 2) ) datetime, * 
	from consumable_levels where datetime = Date('2020-10-28', '-1 day')) yesterday,
	(select DATE(substr(`Report Content DateTime`, 7, 4) || '-' ||
	substr(`Report Content DateTime`, 1, 2) || '-' ||
	substr(`Report Content DateTime`, 4, 2) ) datetime, * 
	from consumable_levels where datetime = Date('2020-10-28')) today
where
	yesterday.`Serial Number` = today.`Serial Number`

# 用已知的 goods_type 去填補 past_delivery_data 中 goods_type 為 NULL 的欄位
update
	past_delivery_data
set
	goods_type = (
	select
		goods_type
	from
		past_delivery_data inside
	where
		past_delivery_data.goods_name = inside.goods_name)
where
	goods_type is null

# 尋找某個序號的最後配送時間及配送的產品
select
	serial,
	Date(substr(arrive_date , 1, 10)) last_deliver_date,
	goods_name,
	goods_type
from
	past_delivery_data
where
	serial = 'AABBCC'
order by
	last_deliver_date
desc
limit 1

# 挑出所有曾經寄送過的資訊，且同一機器同一品項為取最新一筆，將這些寫進 deliver_status 中並設 status 為 FALSE 表示送過了不需要寄送
INSERT INTO
deliver_status 
SELECT
	DATE(substr(past_delivery_data.arrive_date, 1, 10)),	
	past_delivery_data.serial,
	past_delivery_data.goods_name,
	past_delivery_data.goods_type,
	FALSE status
FROM 
	past_delivery_data
inner join consumable_levels
on consumable_levels."Serial Number" = past_delivery_data.serial
GROUP BY 
	past_delivery_data.serial,
	past_delivery_data.goods_name
HAVING MAX(past_delivery_data.arrive_date)